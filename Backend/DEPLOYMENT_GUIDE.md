# 🚀 Tuinue Wasichana - Production Deployment Guide

This guide provides step-by-step instructions for deploying the Tuinue Wasichana API to Render.

## 📋 Table of Contents

1. [Prerequisites](#prerequisites)
2. [Environment Setup](#environment-setup)
3. [Render Deployment](#render-deployment)
4. [Database Setup](#database-setup)
5. [Environment Variables](#environment-variables)
6. [Post-Deployment](#post-deployment)
7. [Monitoring & Maintenance](#monitoring--maintenance)

## 🔧 Prerequisites

### Required Accounts
- [Render Account](https://render.com) (free tier available)
- [Safaricom Developer Account](https://developer.safaricom.co.ke) (for Mpesa integration)
- GitHub account with your code repository

### Required Files
- ✅ `render.yaml` - Render service configuration
- ✅ `Procfile` - Process definitions
- ✅ `requirements.txt` - Python dependencies
- ✅ `deploy.py` - Deployment script
- ✅ `.env.production` - Environment variables template

## 🌍 Environment Setup

### 1. Prepare Your Repository

Ensure your repository contains all necessary files:

```bash
# Check required files exist
ls -la render.yaml Procfile requirements.txt deploy.py

# Commit all changes
git add .
git commit -m "Prepare for production deployment"
git push origin main
```

### 2. Environment Variables

Copy the production environment template:

```bash
cp .env.production .env
```

Update `.env` with your actual production values (see [Environment Variables](#environment-variables) section).

## 🚀 Render Deployment

### Option 1: Using render.yaml (Recommended)

1. **Connect Repository to Render**
   - Go to [Render Dashboard](https://dashboard.render.com)
   - Click "New" → "Blueprint"
   - Connect your GitHub repository
   - Select the repository containing your code

2. **Configure Blueprint**
   - Render will automatically detect `render.yaml`
   - Review the services that will be created:
     - Web Service (Flask API)
     - Worker Service (Celery)
     - PostgreSQL Database
     - Redis Instance

3. **Deploy**
   - Click "Apply" to create all services
   - Render will automatically deploy your application

### Option 2: Manual Service Creation

If you prefer manual setup:

#### A. Create Database
1. Go to Render Dashboard
2. Click "New" → "PostgreSQL"
3. Configure:
   - Name: `tuinue-wasichana-db`
   - Database Name: `tuinue_wasichana`
   - User: `tuinue_user`
   - Plan: Free (or paid for production)

#### B. Create Redis Instance
1. Click "New" → "Redis"
2. Configure:
   - Name: `tuinue-wasichana-redis`
   - Plan: Free (or paid for production)

#### C. Create Web Service
1. Click "New" → "Web Service"
2. Connect your GitHub repository
3. Configure:
   - Name: `tuinue-wasichana-api`
   - Environment: `Python 3`
   - Build Command: `pip install -r requirements.txt`
   - Start Command: `gunicorn --bind 0.0.0.0:$PORT app:app`

#### D. Create Worker Service
1. Click "New" → "Background Worker"
2. Connect your GitHub repository
3. Configure:
   - Name: `tuinue-wasichana-worker`
   - Environment: `Python 3`
   - Build Command: `pip install -r requirements.txt`
   - Start Command: `celery -A celery_app worker --loglevel=info`

## 🗄️ Database Setup

### Automatic Setup
The `deploy.py` script will automatically:
- Create database tables
- Run migrations
- Create default admin user

### Manual Setup (if needed)
If automatic setup fails, run manually:

```bash
# Connect to your Render shell
python deploy.py
```

## 🔐 Environment Variables

Configure these environment variables in Render:

### Required Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `FLASK_ENV` | Environment | `production` |
| `SECRET_KEY` | Flask secret key | Auto-generated by Render |
| `JWT_SECRET_KEY` | JWT secret key | Auto-generated by Render |
| `DATABASE_URL` | PostgreSQL connection | Auto-provided by Render |
| `REDIS_URL` | Redis connection | Auto-provided by Render |

### Mpesa Configuration

| Variable | Description | Where to Get |
|----------|-------------|--------------|
| `MPESA_CONSUMER_KEY` | Mpesa API consumer key | Safaricom Developer Portal |
| `MPESA_CONSUMER_SECRET` | Mpesa API consumer secret | Safaricom Developer Portal |
| `MPESA_BUSINESS_SHORT_CODE` | Your business shortcode | Safaricom |
| `MPESA_PASSKEY` | Mpesa passkey | Safaricom Developer Portal |
| `MPESA_CALLBACK_URL` | Payment callback URL | `https://your-app.onrender.com/api/v1/payments/verify` |

### Optional Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `ADMIN_EMAIL` | Default admin email | `admin@tuinuewasichana.com` |
| `ADMIN_PASSWORD` | Default admin password | `admin123` |
| `CORS_ORIGINS` | Allowed CORS origins | `*` |
| `LOG_LEVEL` | Logging level | `INFO` |

## 📊 Post-Deployment

### 1. Verify Deployment

Check that all services are running:

```bash
# Test API health
curl https://your-app-name.onrender.com/health

# Test user registration
curl -X POST https://your-app-name.onrender.com/api/v1/users/register \
  -H "Content-Type: application/json" \
  -d '{"name":"Test User","email":"test@example.com","password":"password123","role":"donor"}'
```

### 2. Create Admin User

If not created automatically:

```bash
# Login to Render shell and run:
python -c "
from app import create_app
from app.services.database import db
from app.models.user import User

app = create_app()
with app.app_context():
    admin = User(name='Admin', email='admin@tuinuewasichana.com', role='admin')
    admin.set_password('your_secure_password')
    db.session.add(admin)
    db.session.commit()
    print('Admin user created')
"
```

### 3. Test Key Functionality

- ✅ User registration and login
- ✅ Charity application process
- ✅ Donation flow
- ✅ Payment processing (with test credentials)
- ✅ Admin dashboard access

## 📈 Monitoring & Maintenance

### Health Monitoring

Render provides built-in monitoring. Additionally:

- **Health Check Endpoint**: `GET /health`
- **Logs**: Available in Render dashboard
- **Metrics**: CPU, memory, and request metrics

### Database Maintenance

```bash
# Backup database (run in Render shell)
pg_dump $DATABASE_URL > backup.sql

# Run migrations
python -c "from flask_migrate import upgrade; from app import create_app; app = create_app(); app.app_context().push(); upgrade()"
```

### Scaling

#### Web Service Scaling
- Render automatically scales based on traffic
- Configure auto-scaling in service settings

#### Worker Scaling
- Scale Celery workers based on queue length
- Monitor worker performance in logs

### Security Updates

```bash
# Update dependencies
pip install --upgrade -r requirements.txt

# Update requirements.txt
pip freeze > requirements.txt

# Commit and deploy
git add requirements.txt
git commit -m "Update dependencies"
git push origin main
```

## 🔧 Troubleshooting

### Common Issues

#### 1. Database Connection Errors
```bash
# Check DATABASE_URL format
echo $DATABASE_URL
# Should start with postgresql://

# Test connection
python -c "from app import create_app; app = create_app(); print('DB connection OK')"
```

#### 2. Redis Connection Issues
```bash
# Check Redis URL
echo $REDIS_URL

# Test Celery connection
celery -A celery_app inspect ping
```

#### 3. Migration Errors
```bash
# Reset migrations (if safe)
rm -rf migrations/
flask db init
flask db migrate -m "Initial migration"
flask db upgrade
```

#### 4. Environment Variable Issues
- Verify all required variables are set in Render dashboard
- Check for typos in variable names
- Ensure secrets are properly generated

### Logs and Debugging

```bash
# View application logs
# Available in Render dashboard under "Logs" tab

# Enable debug logging
# Set LOG_LEVEL=DEBUG in environment variables
```

## 🚀 Deployment Checklist

### Pre-Deployment
- [ ] All code committed and pushed to GitHub
- [ ] Environment variables configured
- [ ] Mpesa credentials obtained (sandbox for testing)
- [ ] Database backup created (if updating existing deployment)

### Deployment
- [ ] Services created in Render
- [ ] Environment variables set
- [ ] Database and Redis instances running
- [ ] Web service deployed successfully
- [ ] Worker service running

### Post-Deployment
- [ ] Health check endpoint responding
- [ ] Database tables created
- [ ] Admin user created
- [ ] API endpoints tested
- [ ] Payment integration tested (sandbox)
- [ ] Monitoring configured

## 📞 Support

### Render Support
- [Render Documentation](https://render.com/docs)
- [Render Community](https://community.render.com)

### Application Support
- Check application logs in Render dashboard
- Review error messages in deployment logs
- Test endpoints using the provided Postman collection

## 🎉 Success!

Your Tuinue Wasichana API is now deployed to production! 

**Next Steps:**
1. Configure your frontend to use the production API URL
2. Set up monitoring and alerting
3. Configure backup strategies
4. Plan for scaling as your user base grows

**Production URL:** `https://your-app-name.onrender.com`

**API Documentation:** `https://your-app-name.onrender.com/api/v1` (Swagger UI)

Happy deploying! 🚀